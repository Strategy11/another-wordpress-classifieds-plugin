AWPCP.define("awpcp/frontend/listing-fields-section-controller",["jquery","awpcp/settings","awpcp/restricted-length-field","awpcp/multiple-region-selector-validator","awpcp/jquery-validate-methods"],function(a,b,c,d){var e=function(a,b){var c=this;c.id=a.id,c.template=a.template,c.store=b,c.listing=null,c.selectedCategories=[],c.selectedPaymentTerm=null,c.updater=null};return a.extend(e.prototype,{render:function(b){var c=this;return c.$element||(c.$element=a("<div></div>").appendTo(b)),c.shouldUpdateTemplate()?(c.updateSelectedValues(),c.store.setSectionStateToLoading(c.id),c.store.requestSectionUpdate(c.id)):(c.updateSelectedValues(),void c.prepareTemplate())},shouldUpdateTemplate:function(){var a=this,b=a.store.getListingId();if(null===b)return!1;if(b!==a.listing)return!0;var c=a.store.getSelectedCategoriesIds(),d=a.store.getSelectedPaymentTermId();return 0!==c.length&&null!==d&&(!_.isEqual(c,a.selectedCategories)||d!==a.selectedPaymentTerm)},prepareTemplate:function(){var a=this;a.$element.hasClass("rendered")||a.renderTemplate(),a.updateTemplate()},renderTemplate:function(){var d=this;d.$element=a(d.template).replaceAll(d.$element);var e=d.store.getListingFields();d.$regionsSelector=d.$element.find(".awpcp-multiple-region-selector"),b.get("overwrite-contact-information-on-user-change"),a.noop(new c(d.$element.find('[name="ad_title"]'))),a.noop(new c(d.$element.find('[name="ad_details"]'))),d.$regionsSelector.MultipleRegionSelector(e.regions),a.publish("/awpcp/post-listing-page/details-step/ready",[d.$element]),d.$element.on("change",".awpcp-has-value",function(){d.onContinueButtonClicked()}),d.$element.find("form :submit").click(function(a){a.preventDefault(),d.onContinueButtonClicked()}),d.$element.addClass("rendered")},onContinueButtonClicked:function(){var b=this,c={};b.$element.find(".awpcp-has-value").each(function(b,d){var e=a(d);c[e.attr("name")]=e.val()}),c.regions=b.$regionsSelector.data("RegionSelector").getSelectedRegions(),b.store.updateListingFields(c)},updateTemplate:function(a){var b=this,c=b.store.getSectionState(b.id);return"disabled"===c?b.showDisabledMode():"loading"===c?b.showLoadingMode():b.showEditMode()},showDisabledMode:function(){var a=this;a.$element.hide()},showLoadingMode:function(){var a=this;a.$element.find(".awpcp-listing-fields-submit-listing-section__loading_mode").show(),a.$element.find(".awpcp-listing-fields-submit-listing-section__edit_mode").hide(),a.$element.show()},showEditMode:function(){var b=this;b.$element.find(".awpcp-listing-fields-submit-listing-section__loading_mode").hide(),b.$element.find(".awpcp-listing-fields-submit-listing-section__edit_mode").show(),data=b.store.getListingFields(),a.each(data,function(b,c){a('[name="'+b+'"]').val(c)}),b.$element.show()},updateSelectedValues:function(){var a=this;a.listing=a.store.getListingId(),a.selectedCategories=a.store.getSelectedCategoriesIds(),a.selectedPaymentTerm=a.store.getSelectedPaymentTermId()},reload:function(a){var b=this;b.template=a.template,b.$element.removeClass("rendered"),b.prepareTemplate()}}),e}),AWPCP.define("awpcp/frontend/order-section-controller",["jquery","awpcp/categories-selector","awpcp/user-selector","awpcp/payment-terms-list","awpcp/credit-plans-list","awpcp/jquery-userfield","awpcp/jquery-validate-methods"],function(a,b,c,d,e){var f=function(a,b){var c=this;c.id=a.id,c.template=a.template,c.store=b};return a.extend(f.prototype,{render:function(a){var b=this;b.$element||(b.renderTemplate(a),b.updateInitialState()),b.updateTemplate()},renderTemplate:function(f){var g=this;g.$element=a(g.template),f.append(g.$element),g.$editModeContainer=a(".awpcp-order-submit-listing-section__edit_mode"),g.$readModeContainer=a(".awpcp-order-submit-listing-section__read_mode"),g.$listingId=g.$element.find('[name="listing_id"]'),g.$listOfSelectedCategories=a(".awpcp-order-submit-listing-section--selected-categories"),g.$listingOwner=a(".awpcp-order-submit-listing-section--listing-owner"),g.$paymentTerm=a(".awpcp-order-submit-listing-section--payment-term"),g.$creditPlanLabel=a(".awpcp-order-submit-listing-section--credit-plan-label"),g.$creditPlan=a(".awpcp-order-submit-listing-section--credit-plan"),g.paymentTermsList=new d(f.find(".awpcp-payment-terms-list"),{onChange:function(a){g.store.updateSelectedPaymentTerm(a)}}),g.categoriesSelector=new b(f.find(".awpcp-category-dropdown"),{onChange:function(a){g.store.updateSelectedCategories(a)}});var h=f.find(".awpcp-user-selector"),i=a.extend(h.data("configuration"),{onChange:function(a){g.store.updateSelectedUser(a)}});g.userSelector=new c(h,i),g.creditPlansList=new e(f.find(".awpcp-credit-plans-table"),{onChange:function(a){g.store.updateSelectedCreditPlan(a)}}),g.$editModeContainer.find("form").validate({messages:a.AWPCP.l10n("page-place-ad-order"),submitHandler:function(a,b){b.preventDefault(),g.onContinueButtonClicked()}}),f.on("click",".awpcp-order-submit-listing-section--change-selection-button",function(a){a.preventDefault(),g.onChangeSelectionButtonClicked()})},updateInitialState:function(){var a=this;a.store.setListingId(parseInt(a.$listingId.val(),10)),a.store.updateSelectedPaymentTerm(a.paymentTermsList.getSelectedPaymentTerm()),a.store.updateSelectedCategories(a.categoriesSelector.getSelectedCategories()),a.store.updateSelectedUser(a.userSelector.getSelectedUser())},updateTemplate:function(){var a=this;return"read"===a.store.getSectionState(a.id)?void a.updateReadModeTemplate():void a.updateEditModeTemplate()},updateReadModeTemplate:function(){var b=this;b.$editModeContainer.hide(),b.$readModeContainer.show(),b.$listOfSelectedCategories.empty().text(b.store.getSelectedCategoriesNames().join(", ")),b.$listingOwner.find("span").html(b.store.getSelectedUserName()),b.$paymentTerm.hide(),b.$creditPlan.hide();var c=b.store.getSelectedPaymentTerm();c&&(b.$paymentTerm.html(a('[data-id="'+c.type+"-"+c.id+'"]').html()).show(),b.$paymentTerm.find("input").prop("disabled",!0),b.$paymentTerm.find("label").hide(),b.$paymentTerm.find(".awpcp-payment-term-price-in-"+c.mode).show());var d=b.store.getSelectedCreditPlanSummary();d&&b.$creditPlan.show().find("span").html(d)},updateEditModeTemplate:function(){var a=this;a.$readModeContainer.hide(),a.$editModeContainer.show()},onContinueButtonClicked:function(){var a=this;a.store.getListingId()||a.store.createEmptyListing(),a.store.setSectionStateToRead(a.id)},onChangeSelectionButtonClicked:function(){var a=this;a.store.setSectionStateToEdit(a.id)},reload:function(){}}),f}),AWPCP.define("awpcp/frontend/save-section-controller",["jquery"],function(a){var b=function(a,b){var c=this;c.id=a.id,c.template=a.template,c.store=b};return a.extend(b.prototype,{render:function(b){var c=this;return c.$element||(c.$element=a("<div></div>").appendTo(b)),c.shouldUpdateSectionState()?(c.updateSelectedValues(),c.store.setSectionStateToEdit(c.id)):void c.prepareTemplate()},shouldUpdateSectionState:function(){var a=this,b=a.store.getListingId();return null!==b&&b!==a.listing},updateSelectedValues:function(){var a=this;a.listing=a.store.getListingId()},prepareTemplate:function(){var a=this;a.$element.hasClass("rendered")||a.renderTemplate();var b=a.store.getSectionState(a.id);return"disabled"===b?a.showDisabledMode():void a.showEditMode()},renderTemplate:function(){var b=this;b.$element=a(b.template).replaceAll(b.$element),b.$submitButton=b.$element.find(":submit"),b.$submitButton.click(function(a){a.preventDefault(),b.store.saveListingInformation()}),b.$element.addClass("rendered")},showDisabledMode:function(){var a=this;a.$element.hide()},showEditMode:function(){var a=this;a.$element.show()},reload:function(){var a=this;a.prepareTemplate()}}),b}),AWPCP.define("awpcp/frontend/upload-media-section-controller",["jquery","awpcp/media-center","awpcp/settings"],function(a,b,c){var d=function(a,b){var c=this;c.id=a.id,c.template=a.template,c.store=b,c.selectedPaymentTerm=null,c.listing=null};return a.extend(d.prototype,{render:function(b){var c=this;return c.$element||(c.$element=a("<div></div>").appendTo(b)),c.shouldUpdateTemplate()?(c.updateSelectedValues(),c.store.setSectionStateToLoading(c.id),c.store.requestSectionUpdate(c.id)):(c.updateSelectedValues(),void c.prepareTemplate())},shouldUpdateTemplate:function(){var a=this,b=a.store.getListingId();return null!==b&&(b!==a.listing||a.store.getSelectedPaymentTermId()!==a.selectedPaymentTerm)},updateSelectedValues:function(){var a=this;a.selectedPaymentTerm=a.store.getSelectedPaymentTermId(),a.listing=a.store.getListingId()},prepareTemplate:function(){var a=this;a.$element.hasClass("rendered")||a.renderTemplate(),a.updateTemplate()},renderTemplate:function(){var b=this;b.$element=a(b.template).replaceAll(b.$element),b.$element.find(".awpcp-media-center").StartMediaCenter({mediaManagerOptions:c.get("media-manager-data"),mediaUploaderOptions:c.get("media-uploader-data")}),b.$element.addClass("rendered")},updateTemplate:function(){var a=this,b=a.store.getSectionState(a.id);return"disabled"===b?a.showDisabledMode():"loading"===b?a.showLoadingMode():a.showEditMode()},showDisabledMode:function(){var a=this;a.$element.hide()},showLoadingMode:function(){var a=this;a.$element.find(".awpcp-upload-media-listing-section__loading_mode").show(),a.$element.find(".awpcp-upload-media-listing-section__edit_mode").hide(),a.$element.show()},showEditMode:function(){var a=this;a.$element.find(".awpcp-upload-media-listing-section__loading_mode").hide(),a.$element.find(".awpcp-upload-media-listing-section__edit_mode").show(),a.$element.show()},reload:function(a,b){var c=this;c.template=a.template,c.$element.removeClass("rendered"),c.prepareTemplate()}}),d}),AWPCP.define("awpcp/frontend/submit-listing-data-store",["jquery"],function(a){var b=function(a){this.data=a||{},this.refreshCalls=0};return a.extend(b.prototype,{setSectionStateToRead:function(a){var b=this;b.setSectionState(a,"read")},setSectionState:function(a,b){var c=this;c.setSectionStateWithoutRefreshing(a,b),c.refresh()},setSectionStateWithoutRefreshing:function(a,b){var c=this;"undefined"==typeof c.data.sections&&(c.data.sections={}),"undefined"==typeof c.data.sections[a]&&(c.data.sections[a]={}),c.data.sections[a].state=b},setSectionStateToEdit:function(a){var b=this;b.setSectionState(a,"edit")},setSectionStateToLoading:function(a){var b=this;b.setSectionState(a,"loading")},refresh:function(){var a=this;a.refreshCalls=a.refreshCalls+1,"undefined"==typeof a.data.sectionsToUpdate&&(a.data.sectionsToUpdate=[]),a.listener.render(),a.refreshCalls=a.refreshCalls-1,a.refreshCalls<=0&&a.data.sectionsToUpdate.length&&a.updateSections()},getSectionState:function(a){var b=this;return b.data.sections&&b.data.sections[a]&&b.data.sections[a].state?b.data.sections[a].state:"edit"},requestSectionUpdate:function(a){var b=this;b.data.sectionsToUpdate.push(a)},updateSelectedCategories:function(a){var b=this;b.data.categories=a,b.refresh()},getSelectedCategoriesIds:function(){var b=this;return a.map(b.data.categories||[],function(a){return a.id})},getSelectedCategoriesNames:function(){var b=this;return a.map(b.data.categories||[],function(a){return a.name})},updateSelectedUser:function(a){var b=this;b.data.user=a,b.refresh()},getSelectedUserId:function(){var a=this;return a.data.user?a.data.user.id:""},getSelectedUserName:function(){var a=this;return a.data.user?a.data.user.name:""},updateSelectedPaymentTerm:function(a){var b=this;b.data.paymentTerm=a,b.refresh()},getSelectedPaymentTerm:function(){var a=this;return a.data.paymentTerm?a.data.paymentTerm:null},getSelectedPaymentTermId:function(){var a=this;return a.data.paymentTerm?a.data.paymentTerm.id:null},getSelectedPaymentTermSummary:function(){var a=this;return a.data.paymentTerm?a.data.paymentTerm.summary:""},updateSelectedCreditPlan:function(a){var b=this;b.data.creditPlan=a,b.refresh()},getSelectedCreditPlanSummary:function(){var a=this;return a.data.creditPlan?a.data.creditPlan.summary:""},getTransactionId:function(){var a=this;return a.data.transaction?a.data.transaction:null},updateListingFields:function(b){var c=this;c.data.fields=a.extend(c.data.fields||{},b),c.refresh()},setListingId:function(a){var b=this;a&&(b.data.listing={ID:a},b.refresh())},getListingId:function(){var a=this;return a.data.listing?a.data.listing.ID:null},getListingFields:function(){var a=this;return a.data.fields||{}},createEmptyListing:function(){var b,c,d,e=this;b=e.getSelectedPaymentTerm(),c={action:"awpcp_create_empty_listing",nonce:a.AWPCP.get("create_empty_listing_nonce"),categories:e.getSelectedCategoriesIds(),payment_term_id:b.id,payment_term_type:b.type,payment_term_payment_type:b.mode,user_id:e.getSelectedUserId(),current_url:document.location.href},options={url:a.AWPCP.get("ajaxurl"),data:c,dataType:"json",method:"POST"},d=a.ajax(options).done(function(a){return"ok"===a.status&&a.redirect_url?void(document.location.href=a.redirect_url):void("ok"===a.status&&(e.data.listing=a.listing,e.data.transaction=a.transaction,e.refresh()))})},updateSections:function(){var b,c,d=this;b={action:"awpcp_update_submit_listing_sections",sections:d.data.sectionsToUpdate,nonce:a.AWPCP.get("update_submit_listing_sections_nonce"),listing:d.getListingId()},options={url:a.AWPCP.get("ajaxurl"),data:b,dataType:"json",method:"POST"},c=a.ajax(options).done(function(a){"ok"===a.status&&d.listener.reload(a.sections),d.data.sectionsToUpdate=[]})},saveListingInformation:function(){var b,c,d,e=this;b=e.getSelectedPaymentTerm(),c=a.extend({},e.getListingFields(),{action:"awpcp_save_listing_information",nonce:a.AWPCP.get("save_listing_information_nonce"),transaction_id:e.getTransactionId(),ad_id:e.getListingId(),user_id:e.getSelectedUserId(),categories:e.getSelectedCategoriesIds(),payment_term_id:e.getSelectedPaymentTermId(),payment_term_type:b.type,payment_type:b.mode,current_url:document.location.href}),delete c.regions,options={url:a.AWPCP.get("ajaxurl"),data:c,dataType:"json",method:"POST"},d=a.ajax(options).done(function(a){if(console.log("save listing information",a),"ok"===a.status&&a.redirect_url)return void(document.location.href=a.redirect_url)})}}),b}),AWPCP.run("awpcp/frontend/submit-listing-page",["jquery","awpcp/frontend/submit-listing-data-store","awpcp/frontend/order-section-controller","awpcp/frontend/listing-fields-section-controller","awpcp/frontend/upload-media-section-controller","awpcp/frontend/save-section-controller"],function(a,b,c,d,e,f){var g=function(a,b,c){var d=this;d.store=a,d.sections=b,d.$container=c};a.extend(g.prototype,{render:function(){var b=this;a.each(b.sections,function(a,c){c.render(b.$container)})},reload:function(b){var c=this;a.each(b,function(a,b){"undefined"!=typeof c.sections[b.id]&&(c.store.setSectionStateWithoutRefreshing(b.id,b.state),c.sections[b.id].reload(b,c.$container))})}}),a(function(){var h=new b,i={order:new c(AWPCPSubmitListingPageSections[0],h),"listing-fields":new d(AWPCPSubmitListingPageSections[1],h),"upload-media":new e(AWPCPSubmitListingPageSections[2],h),save:new f(AWPCPSubmitListingPageSections[3],h)};h.setSectionStateWithoutRefreshing(AWPCPSubmitListingPageSections[1].id,AWPCPSubmitListingPageSections[1].state),h.setSectionStateWithoutRefreshing(AWPCPSubmitListingPageSections[2].id,AWPCPSubmitListingPageSections[2].state),h.setSectionStateWithoutRefreshing(AWPCPSubmitListingPageSections[3].id,AWPCPSubmitListingPageSections[3].state);var j=new g(h,i,a(".awpcp-submit-listing-page-form"));h.listener=j,h.refresh()})});